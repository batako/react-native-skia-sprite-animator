# プレビュー/アニメーション コンポーネント仕様

## 目的
- フレーム選択コンポーネントで切り出した画像を使い、アニメーションの定義とプレビューを明確に分離する。
- プレビューは表示専用にして、再生・停止の制御は親（エディタ本体）が担う。
- アニメーション編集ではフレームグループ（＝動作）を柔軟に管理し、各フレームの順序・持続時間・コピー/貼り付けなどの編集操作を提供する。
- 編集画面の UX は Godot の AnimatedSprite2D インスペクタを参考にし、動作ごとのタイムラインとプレビューが横並びで連動する構成を意識する。

## コンポーネント構成と責務

### PreviewPlayer（仮称）
- **役割**: 指定されたアニメーションを一定速度で描画するだけの受動的コンポーネント。新規ライブラリ機能ではなく、既存の `SpriteAnimator` ＋ `PlaybackControls` ＋ `useEditorIntegration` を薄くラップして「親が `frames` や `isPlaying` を渡すだけ」の構造にまとめる想定。
- **主要 props**
  - `frames`: `{ id, image, duration }[]` などのシーケンス。切り出し済みビットマップと継続時間を受け取る。
  - `isPlaying`: 再生状態を親から受け取る。内部で再生状態を保持しない。
  - `currentIndex`: 親が管理するカレントフレーム。プレビュー内ではこのインデックスを元に描画だけを行う。
  - `scale`: 拡大率。プレビュー側では描画にのみ使用。
- **制約**
  - 再生/停止ボタンは持たない。
  - 受け取ったフレーム配列は読み取り専用で、編集機能を提供しない。

### AnimationEditor（仮称）
- **役割**: アニメーション（＝動作名ごとのフレームグループ）の定義・編集・操作を司る。
- **主要コンセプト**
  - **動作名**でフレームグループを管理。`default` が初期アニメーション。
  - リストに任意の動作を追加でき、動作ごとにフレーム選択コンポーネントからフレームを投入する。
  - フレームリストは「切り取った画像」+「表示順番号」を並べた一覧。
  - 各動作は個別にプレイバック設定（順序・持続時間）を持つ。
- **UI 要素**
  - 動作一覧：`default` を含むタブまたはカード形式。追加/削除/リネームを提供。
  - フレームリスト：
    - サムネイル + 連番ラベル。
    - 選択状態を示すハイライト。
    - コンテキストメニューまたはボタンで「コピー」「貼り付け」「削除」「順序入れ替え（ドラッグ & ドロップ想定）」を提供。
    - 各フレームに持続時間（ms）入力欄。
    - スケール調整ボタン（拡大・縮小・等倍）をヘッダーに設置し、縮小率はリスト単位で保持。
  - 操作ボタン：
    - **再生**/**停止**ボタンを設置し、押下時に PreviewPlayer に状態を伝播させる。
    - 「フレームを追加」ボタンでフレーム選択コンポーネントを起動して、選択結果を現在の動作に取り込む。
- **データの流れ**
  - フレーム選択コンポーネント → AnimationEditor: `{ id, image, duration?, sourceRect }[]`
  - AnimationEditor → PreviewPlayer: 現在アクティブな動作のフレーム配列と再生状態。
  - AnimationEditor → 親: アニメーション定義（動作名、フレームID列、各フレームの duration）を渡し、保存や他機能と連携。

## インタラクション詳細
- **再生/停止の連携**
  1. AnimationEditor の再生ボタンが押されると、選択中の動作名と `isPlaying=true` を親へ通知。
  2. 親は PreviewPlayer へ `frames` と再生状態を反映。
  3. 停止ボタンで `isPlaying=false` を通知し、PreviewPlayer は先頭フレームまたは停止時のフレームを保持。
- **フレーム編集**
  - **コピー/貼り付け**: クリップボードは動作単位で保持。貼り付け時は元フレームの画像と duration を複製し、新しい ID を振る。
  - **削除**: リストから即時除去し、連番を振り直す。タイムラインが空になった場合は再生不可。
  - **並べ替え**: ドラッグ & ドロップまたは上下ボタンで順序を変更。変更結果は PreviewPlayer の表示順にも即時反映。
  - **持続時間**: 各フレームに数値入力（ms）。未入力時はデフォルト（例: 80ms）を適用。
- **ズーム操作**
  - 拡大 (`+`)、縮小 (`-`)、等倍ボタンをフレームリストヘッダーに配置。
  - ズームはサムネイル表示にのみ影響し、実際の切り抜きサイズは不変。

## 今後の拡張余地
- PreviewPlayer にシーク機能を追加し、AnimationEditor から任意フレームへジャンプできるようにする。
- フレームリストのコピー/貼り付けを動作間で共有する（例: `run` → `attack` へコピー）。
- AnimationEditor 内で FPS やループ設定などの追加メタ情報を編集する UI を検討。

---
この仕様をベースに、PreviewPlayer と AnimationEditor を個別コンポーネントとして実装し、親コンテナ（エディタ）が状態を一元管理する構成とする。PreviewPlayer は既存ライブラリ機能の組み合わせで実現し、AnimationEditor 側の UI/状態管理のみを追加すれば、再生制御・フレーム編集・プレビュー表示を責務ごとに分けつつライブラリ改修なしで進められる。
